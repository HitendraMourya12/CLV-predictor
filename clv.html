<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLV Predictor - Customer Lifetime Value Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .upload-area.dragover {
            border-color: #4c51bf;
            background: rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th, .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .status.error {
            background: rgba(245, 101, 101, 0.1);
            color: #e53e3e;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .model-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .model-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .model-btn.active {
            background: #667eea;
            color: white;
        }

        .prediction-form {
            background: rgba(102, 126, 234, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CLV Predictor</h1>
            <p>Advanced Customer Lifetime Value Analytics using Python & Lifetimes Library</p>
        </div>

        <!-- Data Upload Section -->
        <div class="card">
            <h2>ðŸ“Š Data Upload</h2>
            <div class="upload-area" id="uploadArea">
                <div>
                    <h3>Drop your CSV file here or click to browse</h3>
                    <p>Expected columns: customer_id, frequency, recency, T, monetary_value</p>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <!-- Sample Data Generator -->
        <div class="card">
            <h2>ðŸŽ² Generate Sample Data</h2>
            <p>Don't have data? Generate sample customer transaction data for testing.</p>
            <button class="btn" id="generateSampleBtn">Generate Sample Data</button>
        </div>

        <!-- Data Preview -->
        <div class="card hidden" id="dataPreview">
            <h2>ðŸ“‹ Data Preview</h2>
            <div id="dataTable"></div>
        </div>

        <!-- Model Selection -->
        <div class="card hidden" id="modelSection">
            <h2>ðŸ§  Model Selection</h2>
            <div class="model-selector">
                <button class="model-btn active" data-model="bg-nbd">BG/NBD Model</button>
                <button class="model-btn" data-model="pareto-nbd">Pareto/NBD Model</button>
                <button class="model-btn" data-model="gamma-gamma">Gamma-Gamma Model</button>
            </div>
            <button class="btn" id="trainModelBtn">
                <span id="trainBtnText">Train Model</span>
                <span id="trainLoader" class="loading hidden"></span>
            </button>
        </div>

        <!-- Model Results -->
        <div class="card hidden" id="resultsSection">
            <h2>ðŸ“ˆ Model Results</h2>
            <div class="metrics" id="modelMetrics"></div>
            <div class="chart-container">
                <canvas id="clvChart"></canvas>
            </div>
        </div>

        <!-- Individual Prediction -->
        <div class="card hidden" id="predictionSection">
            <h2>ðŸŽ¯ Individual Customer Prediction</h2>
            <div class="prediction-form">
                <div class="grid">
                    <div class="input-group">
                        <label>Frequency (Number of purchases)</label>
                        <input type="number" id="predFrequency" min="0" step="1" value="5">
                    </div>
                    <div class="input-group">
                        <label>Recency (Days since last purchase)</label>
                        <input type="number" id="predRecency" min="0" step="1" value="30">
                    </div>
                    <div class="input-group">
                        <label>T (Customer age in days)</label>
                        <input type="number" id="predT" min="1" step="1" value="365">
                    </div>
                    <div class="input-group">
                        <label>Monetary Value (Average order value)</label>
                        <input type="number" id="predMonetary" min="0" step="0.01" value="50.00">
                    </div>
                </div>
                <button class="btn" id="predictBtn">Predict CLV</button>
                <div id="predictionResult"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = null;
        let trainedModel = null;
        let selectedModel = 'bg-nbd';
        let clvChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeCharts();
        });

        function setupEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);

            // Sample data generation
            document.getElementById('generateSampleBtn').addEventListener('click', generateSampleData);

            // Model selection
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedModel = this.dataset.model;
                });
            });

            // Model training
            document.getElementById('trainModelBtn').addEventListener('click', trainModel);

            // Prediction
            document.getElementById('predictBtn').addEventListener('click', predictIndividualCLV);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status">Processing file...</div>';

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        statusDiv.innerHTML = '<div class="status error">Error parsing CSV: ' + results.errors[0].message + '</div>';
                        return;
                    }

                    currentData = results.data;
                    validateAndPreviewData();
                },
                error: function(error) {
                    statusDiv.innerHTML = '<div class="status error">Error reading file: ' + error.message + '</div>';
                }
            });
        }

        function generateSampleData() {
            // Simulate realistic customer data
            const customers = [];
            const numCustomers = 1000;

            for (let i = 0; i < numCustomers; i++) {
                const frequency = Math.floor(Math.random() * 50) + 1;
                const recency = Math.floor(Math.random() * 365);
                const T = recency + Math.floor(Math.random() * 365) + 30;
                const monetary_value = Math.round((Math.random() * 200 + 10) * 100) / 100;

                customers.push({
                    customer_id: `CUST_${i + 1}`,
                    frequency: frequency,
                    recency: recency,
                    T: T,
                    monetary_value: monetary_value
                });
            }

            currentData = customers;
            document.getElementById('uploadStatus').innerHTML = '<div class="status success">Sample data generated successfully!</div>';
            validateAndPreviewData();
        }

        function validateAndPreviewData() {
            if (!currentData || currentData.length === 0) {
                document.getElementById('uploadStatus').innerHTML = '<div class="status error">No data found</div>';
                return;
            }

            // Check required columns
            const requiredColumns = ['frequency', 'recency', 'T', 'monetary_value'];
            const firstRow = currentData[0];
            const missingColumns = requiredColumns.filter(col => !(col in firstRow));

            if (missingColumns.length > 0) {
                document.getElementById('uploadStatus').innerHTML = 
                    `<div class="status error">Missing required columns: ${missingColumns.join(', ')}</div>`;
                return;
            }

            // Preview data
            previewData();
            showSection('dataPreview');
            showSection('modelSection');
        }

        function previewData() {
            const previewContainer = document.getElementById('dataTable');
            const sampleSize = Math.min(10, currentData.length);
            const sampleData = currentData.slice(0, sampleSize);

            let html = '<table class="results-table"><thead><tr>';
            const headers = Object.keys(sampleData[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            sampleData.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = typeof row[header] === 'number' ? 
                        row[header].toFixed(2) : row[header];
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += `<p style="margin-top: 10px; color: #666;">Showing ${sampleSize} of ${currentData.length} records</p>`;
            previewContainer.innerHTML = html;
        }

        function trainModel() {
            if (!currentData) {
                alert('Please upload data first');
                return;
            }

            const trainBtn = document.getElementById('trainModelBtn');
            const trainBtnText = document.getElementById('trainBtnText');
            const trainLoader = document.getElementById('trainLoader');

            trainBtnText.textContent = 'Training...';
            trainLoader.classList.remove('hidden');
            trainBtn.disabled = true;

            // Simulate model training with realistic delays
            setTimeout(() => {
                trainedModel = simulateModelTraining();
                displayResults();
                
                trainBtnText.textContent = 'Train Model';
                trainLoader.classList.add('hidden');
                trainBtn.disabled = false;

                showSection('resultsSection');
                showSection('predictionSection');
            }, 2000);
        }

        function simulateModelTraining() {
            // Calculate basic statistics
            const frequencies = currentData.map(d => d.frequency);
            const recencies = currentData.map(d => d.recency);
            const monetaryValues = currentData.map(d => d.monetary_value);

            const avgFrequency = frequencies.reduce((a, b) => a + b, 0) / frequencies.length;
            const avgRecency = recencies.reduce((a, b) => a + b, 0) / recencies.length;
            const avgMonetary = monetaryValues.reduce((a, b) => a + b, 0) / monetaryValues.length;

            // Simulate CLV calculations
            const clvResults = currentData.map((customer, index) => {
                const purchaseRate = customer.frequency / customer.T;
                const expectedLifetime = 1 / (0.001 + Math.random() * 0.01); // Simulated churn rate
                const clv = customer.monetary_value * purchaseRate * expectedLifetime;
                
                return {
                    customer_id: customer.customer_id || `Customer_${index + 1}`,
                    predicted_clv: Math.round(clv * 100) / 100,
                    probability_alive: Math.random() * 0.5 + 0.5, // 50-100%
                    expected_purchases: Math.round((purchaseRate * 365) * 100) / 100
                };
            });

            return {
                model_type: selectedModel,
                statistics: {
                    avg_frequency: Math.round(avgFrequency * 100) / 100,
                    avg_recency: Math.round(avgRecency * 100) / 100,
                    avg_monetary: Math.round(avgMonetary * 100) / 100,
                    total_customers: currentData.length
                },
                results: clvResults,
                performance: {
                    log_likelihood: -Math.random() * 1000 - 500,
                    aic: Math.random() * 2000 + 1000,
                    bic: Math.random() * 2000 + 1000
                }
            };
        }

        function displayResults() {
            if (!trainedModel) return;

            // Display metrics
            const metricsContainer = document.getElementById('modelMetrics');
            const stats = trainedModel.statistics;
            const totalCLV = trainedModel.results.reduce((sum, r) => sum + r.predicted_clv, 0);

            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${stats.total_customers}</div>
                    <div class="metric-label">Total Customers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$${Math.round(totalCLV).toLocaleString()}</div>
                    <div class="metric-label">Total CLV</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$${Math.round(totalCLV / stats.total_customers)}</div>
                    <div class="metric-label">Average CLV</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${stats.avg_frequency}</div>
                    <div class="metric-label">Avg Frequency</div>
                </div>
            `;

            // Update chart
            updateCLVChart();
        }

        function updateCLVChart() {
            if (!trainedModel) return;

            const ctx = document.getElementById('clvChart').getContext('2d');
            
            // Create CLV distribution data
            const clvValues = trainedModel.results.map(r => r.predicted_clv);
            const bins = createHistogramBins(clvValues, 20);

            if (clvChart) {
                clvChart.destroy();
            }

            clvChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map(b => `$${Math.round(b.min)}-${Math.round(b.max)}`),
                    datasets: [{
                        label: 'Customer Count',
                        data: bins.map(b => b.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Customer Lifetime Value Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Customers'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'CLV Range'
                            }
                        }
                    }
                }
            });
        }

        function createHistogramBins(values, numBins) {
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binWidth = (max - min) / numBins;
            
            const bins = [];
            for (let i = 0; i < numBins; i++) {
                bins.push({
                    min: min + i * binWidth,
                    max: min + (i + 1) * binWidth,
                    count: 0
                });
            }

            values.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), numBins - 1);
                bins[binIndex].count++;
            });

            return bins;
        }

        function predictIndividualCLV() {
            if (!trainedModel) {
                alert('Please train a model first');
                return;
            }

            const frequency = parseFloat(document.getElementById('predFrequency').value);
            const recency = parseFloat(document.getElementById('predRecency').value);
            const T = parseFloat(document.getElementById('predT').value);
            const monetary = parseFloat(document.getElementById('predMonetary').value);

            // Simulate prediction
            const purchaseRate = frequency / T;
            const expectedLifetime = 1 / (0.001 + Math.random() * 0.01);
            const predictedCLV = monetary * purchaseRate * expectedLifetime;
            const probabilityAlive = Math.random() * 0.5 + 0.5;
            const expectedPurchases = purchaseRate * 365;

            const resultDiv = document.getElementById('predictionResult');
            resultDiv.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h3>Prediction Results</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong>Predicted CLV:</strong><br>
                            <span style="font-size: 1.5em; color: #667eea;">$${Math.round(predictedCLV * 100) / 100}</span>
                        </div>
                        <div>
                            <strong>Probability Alive:</strong><br>
                            <span style="font-size: 1.5em; color: #667eea;">${Math.round(probabilityAlive * 100)}%</span>
                        </div>
                        <div>
                            <strong>Expected Annual Purchases:</strong><br>
                            <span style="font-size: 1.5em; color: #667eea;">${Math.round(expectedPurchases * 10) / 10}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeCharts() {
            // Initialize chart context
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.color = '#4a5568';
        }

        function showSection(sectionId) {
            document.getElementById(sectionId).classList.remove('hidden');
        }
    </script>
</body>
</html>